<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>WSL 使用 Windows 侧代理 - 猫四叔</title><script>(function(e,t){e[t]=e[t].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="WSL 使用 Windows 侧代理"><meta property="og:description" content="在 WSL2 中使用 git clone 下载 GitHub 上的项目时由于网络原因经常会失败，使用 Windows 侧的代理可以避免此类问题。"><meta property="og:type" content="article"><meta property="og:url" content="https://yuanj.top/posts/d177c0aa/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-07T17:05:26+00:00"><meta property="article:modified_time" content="2023-06-07T17:05:26+00:00"><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title=猫四叔 rel=home><div class="logo__item logo__text"><div class=logo__title>猫四叔</div><div class=logo__tagline>思绪来得快去得也快，偶尔会在这里停留</div></div></a></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>WSL 使用 Windows 侧代理</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2023-06-07T17:05:26Z>June 07, 2023</time></div></div></header><div class="content post__content clearfix"><p>在 WSL2 中使用 git clone 下载 GitHub 上的项目时由于网络原因经常会失败，使用 Windows 侧的代理可以避免此类问题。</p><h2 id=wsl1-和-wsl2-的区别>WSL1 和 WSL2 的区别</h2><p>WSL1 和 WSL2 的网络主要有以下几个区别</p><ol><li><p>WSL1 使用的是和 Windows 主机相同的网络栈，因此和 Windows 共享同一网络接口、IP 地址和 DNS 信息，但性能较差。</p></li><li><p>WSL2 使用了 Hyper-V 虚拟化技术，因此网络栈和 Windows 主机是隔离的，需要单独配置网络。WSL2 使用了虚拟化网络，每个 WSL2 实例对应一个虚拟交换机和虚拟网卡，该虚拟交换机相当于一个软件路由器，将 WSL2 的网络流量通过 Windows 主机的物理网卡转发到物理网络上。因此 WSL2 性能更好、更稳定，但需要单独配置网络，也可能存在一些网络配置上的问题。</p></li><li><p>WSL2 支持 Windows 本地主机的 SSH 连接，可以通过 SSH 连接 WSL2 中的 Linux 系统，而 WSL1 不支持此功能。</p></li></ol><p>总体来说，WSL2 相较于 WSL1 更为出色，其虚拟网络技术能够提供更好的性能和更高的隔离性，同时对 SSH 的支持也更加完善。</p><h2 id=wsl1-代理>WSL1 代理</h2><p>由于 Linux 子系统和 Windows 共享了网络端口，所以访问 Windows 的代理非常简单。例如 Windows 的代理客户端监听了 8000 端口，那么只需要在 Linux 子系统中执行如下命令，就可以让当前 session 中的请求通过代理访问互联网。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export ALL_PROXY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://127.0.0.1:8000&#34;</span>
</span></span></code></pre></div><h2 id=wsl2-代理>WSL2 代理</h2><p>有两个关键步骤：</p><ol><li>WSL2 中配置的代理要指向 Windows 的 IP；</li><li>Windows 上的代理客户端需要允许来自本地局域网的请求；<br>由于 Linux 子系统也是通过 Windows 访问网络，所以 Linux 子系统中的网关指向的是 Windows，DNS 服务器指向的也是 Windows，基于这两个特性，我们可以将 Windows 的 IP 读取出来。</li></ol><p>例如，我使用的是 Debian 子系统，通过 <code>cat /etc/resolv.conf</code> 查看 DNS 服务器 IP。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>## This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## [network]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>## generateResolvConf = false</span>
</span></span><span style=display:flex><span>nameserver 172.27.144.1
</span></span></code></pre></div><p>可以看到 DNS 服务器是  <code>172.19.80.1</code>，通过环境变量  <code>ALL_PROXY</code>  配置代理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export ALL_PROXY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://172.25.144.1:37507&#34;</span>
</span></span></code></pre></div><p>37507 是 Windows 上运行的代理客户端的端口，记得要在 Windows 代理客户端上配置允许本地局域网请求</p><h2 id=一键配置>一键配置</h2><p>将上面的过程写入终端配置文件，就可以一直使用代理</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>host_ip<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat /etc/resolv.conf |grep <span style=color:#e6db74>&#34;nameserver&#34;</span> |cut -f <span style=color:#ae81ff>2</span> -d <span style=color:#e6db74>&#34; &#34;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>export ALL_PROXY<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;socks5://</span>$host_ip<span style=color:#e6db74>:37507&#34;</span>
</span></span></code></pre></div><p>脚本通过  <code>cat /etc/resolv.conf</code>  来获取 DNS 服务器，也就是 Windows 的 IP，再将其中的 IP 部分截取出来，加上代理客户端的端口（我的是 37507，可以根据自己实际情况修改），使用 export 写入环境变量中</p></div></article></main><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/posts/309de741/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>Windows10 & 11 安装 WSL2</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/posts/2eef5da0/ rel=next><span class=pager__subtitle>Next&#8201;»</span><p class=pager__title>蛋白互作网络美化</p></a></div></nav></div></div></div><script async defer src=/js/menu.js></script></body></html>