<!doctype html><html lang=en-US><head><meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://yuanj.top/images/favicon.ico><title>自托管 Gitlab and 极狐 Gitlab 自动化 CI/CD 实践 | UncleCAT4</title><meta name=title content="自托管 Gitlab and 极狐 Gitlab 自动化 CI/CD 实践"><meta name=description content="最近将代码全部迁到极狐的 Gitlab 了，极狐与原生的 Gitlab 几乎一模一样，不过对国内开发者的支持更好，Cli/CD 也不需要验证信用卡可以直接使用 Vercel 默认可以直接导入的仓库只有 GitHub、原生 Gitlab、Bitbucket 和 Azure，本来我是通过镜像仓库把仓库同步发到 GitHub 再用 Vercle 部署的，今天看到 Vercel 的文档说可以使用 Cli/CD 将自托管的项目部署到 Vercel，尝试了一下
自动部署博客到 Vercel 先到 Vercel 的 token 设置 中创建一个 token，加在 Gitlab 仓库 Cli/CD 的环境变量里面，变量名为VERCEL_TOKEN
然后在本地仓库创建.gitlab-ci.yml配置文件
内容如下
default: image: node:16.16.0 deploy_preview: stage: deploy except: - main script: - npm install --global vercel - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN - vercel build --token=$VERCEL_TOKEN - vercel deploy --prebuilt --token=$VERCEL_TOKEN deploy_production: stage: deploy only: - main script: - npm install --global vercel - vercel pull --yes --environment=production --token=$VERCEL_TOKEN - vercel build --prod --token=$VERCEL_TOKEN - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN 直接 push 到远程仓库，项目名称会由 Vercel 自动创建，默认与仓库名是一致的"><meta name=keywords content="Gitlab,"><meta property="og:title" content="自托管 Gitlab and 极狐 Gitlab 自动化 CI/CD 实践"><meta property="og:description" content="最近将代码全部迁到极狐的 Gitlab 了，极狐与原生的 Gitlab 几乎一模一样，不过对国内开发者的支持更好，Cli/CD 也不需要验证信用卡可以直接使用 Vercel 默认可以直接导入的仓库只有 GitHub、原生 Gitlab、Bitbucket 和 Azure，本来我是通过镜像仓库把仓库同步发到 GitHub 再用 Vercle 部署的，今天看到 Vercel 的文档说可以使用 Cli/CD 将自托管的项目部署到 Vercel，尝试了一下
自动部署博客到 Vercel 先到 Vercel 的 token 设置 中创建一个 token，加在 Gitlab 仓库 Cli/CD 的环境变量里面，变量名为VERCEL_TOKEN
然后在本地仓库创建.gitlab-ci.yml配置文件
内容如下
default: image: node:16.16.0 deploy_preview: stage: deploy except: - main script: - npm install --global vercel - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN - vercel build --token=$VERCEL_TOKEN - vercel deploy --prebuilt --token=$VERCEL_TOKEN deploy_production: stage: deploy only: - main script: - npm install --global vercel - vercel pull --yes --environment=production --token=$VERCEL_TOKEN - vercel build --prod --token=$VERCEL_TOKEN - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN 直接 push 到远程仓库，项目名称会由 Vercel 自动创建，默认与仓库名是一致的"><meta property="og:type" content="article"><meta property="og:url" content="https://yuanj.top/posts/56d5b593/"><meta property="og:image" content="https://yuanj.top/images/avatare.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-25T16:21:54+00:00"><meta property="article:modified_time" content="2023-06-25T16:21:54+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://yuanj.top/images/avatare.png"><meta name=twitter:title content="自托管 Gitlab and 极狐 Gitlab 自动化 CI/CD 实践"><meta name=twitter:description content="最近将代码全部迁到极狐的 Gitlab 了，极狐与原生的 Gitlab 几乎一模一样，不过对国内开发者的支持更好，Cli/CD 也不需要验证信用卡可以直接使用 Vercel 默认可以直接导入的仓库只有 GitHub、原生 Gitlab、Bitbucket 和 Azure，本来我是通过镜像仓库把仓库同步发到 GitHub 再用 Vercle 部署的，今天看到 Vercel 的文档说可以使用 Cli/CD 将自托管的项目部署到 Vercel，尝试了一下
自动部署博客到 Vercel 先到 Vercel 的 token 设置 中创建一个 token，加在 Gitlab 仓库 Cli/CD 的环境变量里面，变量名为VERCEL_TOKEN
然后在本地仓库创建.gitlab-ci.yml配置文件
内容如下
default: image: node:16.16.0 deploy_preview: stage: deploy except: - main script: - npm install --global vercel - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN - vercel build --token=$VERCEL_TOKEN - vercel deploy --prebuilt --token=$VERCEL_TOKEN deploy_production: stage: deploy only: - main script: - npm install --global vercel - vercel pull --yes --environment=production --token=$VERCEL_TOKEN - vercel build --prod --token=$VERCEL_TOKEN - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN 直接 push 到远程仓库，项目名称会由 Vercel 自动创建，默认与仓库名是一致的"><meta itemprop=name content="自托管 Gitlab and 极狐 Gitlab 自动化 CI/CD 实践"><meta itemprop=description content="最近将代码全部迁到极狐的 Gitlab 了，极狐与原生的 Gitlab 几乎一模一样，不过对国内开发者的支持更好，Cli/CD 也不需要验证信用卡可以直接使用 Vercel 默认可以直接导入的仓库只有 GitHub、原生 Gitlab、Bitbucket 和 Azure，本来我是通过镜像仓库把仓库同步发到 GitHub 再用 Vercle 部署的，今天看到 Vercel 的文档说可以使用 Cli/CD 将自托管的项目部署到 Vercel，尝试了一下
自动部署博客到 Vercel 先到 Vercel 的 token 设置 中创建一个 token，加在 Gitlab 仓库 Cli/CD 的环境变量里面，变量名为VERCEL_TOKEN
然后在本地仓库创建.gitlab-ci.yml配置文件
内容如下
default: image: node:16.16.0 deploy_preview: stage: deploy except: - main script: - npm install --global vercel - vercel pull --yes --environment=preview --token=$VERCEL_TOKEN - vercel build --token=$VERCEL_TOKEN - vercel deploy --prebuilt --token=$VERCEL_TOKEN deploy_production: stage: deploy only: - main script: - npm install --global vercel - vercel pull --yes --environment=production --token=$VERCEL_TOKEN - vercel build --prod --token=$VERCEL_TOKEN - vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN 直接 push 到远程仓库，项目名称会由 Vercel 自动创建，默认与仓库名是一致的"><meta itemprop=datePublished content="2023-06-25T16:21:54+00:00"><meta itemprop=dateModified content="2023-06-25T16:21:54+00:00"><meta itemprop=wordCount content="247"><meta itemprop=image content="https://yuanj.top/images/avatare.png"><meta itemprop=keywords content="Gitlab,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%;display:block;margin-left:auto;margin-right:auto}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#3273dc}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=/ class=title><h2>UncleCAT4</h2></a><nav><a href=/posts>Blog</a>
<a href=/journal>Journal</a>
<a href=/gestbook>Gestbook</a></nav></header><main><content><blockquote><p>最近将代码全部迁到极狐的 Gitlab 了，极狐与原生的 Gitlab 几乎一模一样，不过对国内开发者的支持更好，Cli/CD 也不需要验证信用卡可以直接使用
Vercel 默认可以直接导入的仓库只有 GitHub、原生 Gitlab、Bitbucket 和 Azure，本来我是通过镜像仓库把仓库同步发到 GitHub 再用 Vercle 部署的，今天看到 Vercel 的文档说可以使用 Cli/CD 将自托管的项目部署到 Vercel，尝试了一下</p></blockquote><h2 id=自动部署博客到-vercel>自动部署博客到 Vercel</h2><p>先到 Vercel 的 <a href=https://vercel.com/account/tokens>token 设置</a> 中创建一个 token，加在 Gitlab 仓库 Cli/CD 的环境变量里面，变量名为<code>VERCEL_TOKEN</code></p><p>然后在本地仓库创建<code>.gitlab-ci.yml</code>配置文件</p><p>内容如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>default</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>node:16.16.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>deploy_preview</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>except</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm install --global vercel</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vercel pull --yes --environment=preview --token=$VERCEL_TOKEN</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vercel build --token=$VERCEL_TOKEN</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vercel deploy --prebuilt  --token=$VERCEL_TOKEN</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>deploy_production</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm install --global vercel</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vercel pull --yes --environment=production --token=$VERCEL_TOKEN</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vercel build --prod --token=$VERCEL_TOKEN</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN</span>
</span></span></code></pre></div><p>直接 push 到远程仓库，项目名称会由 Vercel 自动创建，默认与仓库名是一致的</p><p>部署过程比较慢，大概三四分钟就可以在 Vercel 的控制台看到项目了</p><h2 id=自动发布-npm-包>自动发布 npm 包</h2><p>先在本地登录、初始化、发布包</p><p>然后再到 npm 官网创建一个 token，添加到 Cli/CD 的环境变量中</p><p>本地创建<code>.gitlab-ci.yml</code>配置文件</p><p>内容如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>image</span>: <span style=color:#ae81ff>node:latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>stages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>deploy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>echo &#34;//registry.npmjs.org/:_authToken=\${NPM_TOKEN}&#34;&gt;.npmrc</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm install</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm publish</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>: <span style=color:#ae81ff>production</span>
</span></span></code></pre></div><p><code>NPM_TOKEN</code>要与环境变量里的变量名一致</p><p>然后依次执行下列命令发布包</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git add .
</span></span><span style=display:flex><span>git commit -m <span style=color:#e6db74>&#34;npm publish&#34;</span>  <span style=color:#75715e>## 提交信息，可自定义</span>
</span></span><span style=display:flex><span>npm version patch  <span style=color:#75715e>## 更新版本号</span>
</span></span><span style=display:flex><span>git push
</span></span></code></pre></div><p>后面每次发布新版本的包也是上面的命令</p><h2 id=使用-cloudflare-workers-部署站点>使用 Cloudflare Workers 部署站点</h2><p>需要先克隆 <a href=https://github.com/cloudflare/worker-sites-template/tree/wrangler2>仓库</a> 中的文件，并且修改 wrangler.toml 中的信息</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#f92672>default</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>ubuntu:latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>CF_Workers_deploy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>stage</span>: <span style=color:#ae81ff>deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>only</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>main</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>script</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>sed -i &#39;s@//.*archive.ubuntu.com@//mirrors.ustc.edu.cn@g&#39; /etc/apt/sources.list</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apt-get update &amp;&amp; apt-get install -y hugo curl</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>curl -sL https://deb.nodesource.com/setup_18.x | bash -</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>apt-get update &amp;&amp; apt-get install -y nodejs build-essential</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>hugo</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm config set registry https://registry.npmmirror.com/</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm install wrangler -g</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>npm install @cloudflare/kv-asset-handler</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>wrangler deploy</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>variables</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>CLOUDFLARE_API_TOKEN</span>: <span style=color:#ae81ff>$CF_API_TOKEN</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>CLOUDFLARE_ACCOUNT_ID</span>: <span style=color:#ae81ff>$CF_ACCOUNT_ID</span>
</span></span></code></pre></div><p>需要绑定两个变量 CF_API_TOKEN 和 CF_ACCOUNT_ID</p><h2 id=参考文档>参考文档</h2><p><a href=https://docs.gitlab.cn/jh/user/packages/npm_registry/#%E5%8F%91%E5%B8%83%E4%B8%80%E4%B8%AA-npm-%E5%8C%85>发布 npm 包 | Gitlab</a></p><p><a href=https://vercel.com/guides/how-can-i-use-gitlab-pipelines-with-vercel>How can I use GitLab Pipelines with Vercel?</a></p></content><p><a href=https://yuanj.top/posts/gitlab/>#Gitlab</a></p></main><footer>© 2023 UncleCAT4</footer></body></html>