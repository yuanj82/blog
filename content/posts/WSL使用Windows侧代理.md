---
title: WSL 使用 Windows 侧代理
tags: [WSL]
slug: d177c0aa
date: 2023-06-07 17:05:26
---

在 WSL2 中使用 git clone 下载 GitHub 上的项目时由于网络原因经常会失败，使用 Windows 侧的代理可以避免此类问题。

<!--more-->

## WSL1 和 WSL2 的区别

WSL1 和 WSL2 的网络主要有以下几个区别

1. WSL1 使用的是和 Windows 主机相同的网络栈，因此和 Windows 共享同一网络接口、IP 地址和 DNS 信息，但性能较差。

2. WSL2 使用了 Hyper-V 虚拟化技术，因此网络栈和 Windows 主机是隔离的，需要单独配置网络。WSL2 使用了虚拟化网络，每个 WSL2 实例对应一个虚拟交换机和虚拟网卡，该虚拟交换机相当于一个软件路由器，将 WSL2 的网络流量通过 Windows 主机的物理网卡转发到物理网络上。因此 WSL2 性能更好、更稳定，但需要单独配置网络，也可能存在一些网络配置上的问题。

3. WSL2 支持 Windows 本地主机的 SSH 连接，可以通过 SSH 连接 WSL2 中的 Linux 系统，而 WSL1 不支持此功能。

总体来说，WSL2 相较于 WSL1 更为出色，其虚拟网络技术能够提供更好的性能和更高的隔离性，同时对 SSH 的支持也更加完善。

## WSL1 代理

由于 Linux 子系统和 Windows 共享了网络端口，所以访问 Windows 的代理非常简单。例如 Windows 的代理客户端监听了 8000 端口，那么只需要在 Linux 子系统中执行如下命令，就可以让当前 session 中的请求通过代理访问互联网。

```bash
export ALL_PROXY="http://127.0.0.1:8000"
```

## WSL2 代理

有两个关键步骤：

1. WSL2 中配置的代理要指向 Windows 的 IP；
2. Windows 上的代理客户端需要允许来自本地局域网的请求；  
   由于 Linux 子系统也是通过 Windows 访问网络，所以 Linux 子系统中的网关指向的是 Windows，DNS 服务器指向的也是 Windows，基于这两个特性，我们可以将 Windows 的 IP 读取出来。

例如，我使用的是 Debian 子系统，通过 `cat /etc/resolv.conf` 查看 DNS 服务器 IP。

```bash
## This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
## [network]
## generateResolvConf = false
nameserver 172.27.144.1
```

可以看到 DNS 服务器是  `172.19.80.1`，通过环境变量  `ALL_PROXY`  配置代理

```bash
export ALL_PROXY="http://172.25.144.1:37507"
```

37507 是 Windows 上运行的代理客户端的端口，记得要在 Windows 代理客户端上配置允许本地局域网请求

## 一键配置

将上面的过程写入终端配置文件，就可以一直使用代理

```bash
#!/bin/bash
host_ip=$(cat /etc/resolv.conf |grep "nameserver" |cut -f 2 -d " ")
export ALL_PROXY="socks5://$host_ip:37507"
```

脚本通过  `cat /etc/resolv.conf`  来获取 DNS 服务器，也就是 Windows 的 IP，再将其中的 IP 部分截取出来，加上代理客户端的端口（我的是 37507，可以根据自己实际情况修改），使用 export 写入环境变量中
